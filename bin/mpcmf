#!/usr/bin/env php
<?php

namespace mpcmf\bin;

use mpcmf\system\application\applicationInstance;
use mpcmf\system\configuration\config;
use mpcmf\system\io\log;

$startTime = microtime(true);
$rootFile = '.mpcmfroot';

$appRoot = null;
$currentPath = __DIR__;
while (($parentPath = dirname($currentPath)) !== $currentPath) {
    $currentPath = $parentPath;
    if (in_array($rootFile, scandir($currentPath), true)) {
        $appRoot = $currentPath;
    }
}

if ($appRoot === null) {
    error_log("Unable to find project root (not found \"{$rootFile}\"), absolute root found: \"{$currentPath}\"");
    exit();
}

define('APP_ROOT', $appRoot);

require_once APP_ROOT . '/vendor/autoload.php';
require_once APP_ROOT . '/vendor/infostars/mpcmf-core/src/loader.php';

if(!isset($argv[1]) || empty($argv[1])) {
    echo "=== Error! ===\nUsage: " . basename(__FILE__) . " apps/mpcmf-application.php\n\n";
    exit;
}

$appPath = APP_ROOT . DIRECTORY_SEPARATOR . $argv[1];

if(!file_exists($appPath) || !is_readable($appPath)) {
    echo "=== Error! ===\nApplication not found at {$appPath}\n\n";
    exit;
}

$appName = basename($argv[1], '.php');

unset($argv[1]);
$argv = array_values($argv);
$_SERVER['argv'] = $argv;

$appFullClassPath = dirname(str_replace(APP_ROOT, APP_NAME, $appPath)) . DIRECTORY_SEPARATOR . $appName;

$appFullClass = str_replace(DIRECTORY_SEPARATOR, config::NAMESPACE_SEPARATOR, $appFullClassPath);

$application = applicationInstance::getInstance();
$application->setApplication(new $appFullClass());
$application->run();

if(log::factory()->isHandling(log::DEBUG)) {
    $period = microtime(true) - $startTime;
    echo "\n\n== DEBUG ==\n - total time: " . number_format($period, 4) . " seconds\n\n";
}
